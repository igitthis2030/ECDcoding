const express = require('express');\nconst path = require('path');\nconst dotenv = require('dotenv');\nconst { generateSignature } = require('./payfast/payfast');\nconst { buildSubscriptionParams } = require('./payfast/subscription');\n\n// Node 18+ provides global fetch; ensure runtime meets engines in package.json\n\ndotenv.config();\n\nconst app = express();\napp.use(express.urlencoded({ extended: true }));\napp.use(express.json());\napp.use('/public', express.static(path.join(__dirname, 'public')));\napp.use(express.static(path.join(__dirname, 'public')));\n\nconst PORT = process.env.PORT || 3000;\nconst MODE = (process.env.PAYFAST_MODE || 'sandbox').toLowerCase();\nconst PAYFAST_BASE = MODE === 'live' ? 'https://www.payfast.co.za' : 'https://sandbox.payfast.co.za';\n\nconst MERCHANT_ID = process.env.PAYFAST_MERCHANT_ID;\nconst MERCHANT_KEY = process.env.PAYFAST_MERCHANT_KEY;\nconst PASSPHRASE = process.env.PAYFAST_PASSPHRASE || '';\nconst PUBLIC_BASE_URL = process.env.PUBLIC_BASE_URL || `http://localhost:${PORT}`;\n\n// Tiny in-memory stores for demo purposes\nconst orders = {};\nconst subscriptions = {};\n\nfunction buildPayFastForm(actionUrl, params) {\n  const inputs = Object.entries(params)\n    .map(([k, v]) => `<input type="hidden" name="${k}" value="${String(v)}">`)\n    .join('\n');\n\n  return `<!doctype html>\n  <html>\n    <head><meta charset="utf-8"><title>Redirecting to PayFast...</title></head>\n    <body>\n      <p>Redirecting to PayFast â€” if you are not redirected, click the button below.</p>\n      <form id="payForm" action="${actionUrl}" method="post">\n        ${inputs}\n        <noscript><button type="submit">Pay with PayFast</button></noscript>\n      </form>\n      <script>document.getElementById('payForm').submit();</script>\n    </body>\n  </html>`;\n}\n\n/**\n * Create a one-off payment and redirect user to PayFast\n */\napp.post('/create-payment', (req, res) => {\n  const { amount, item_name, email } = req.body;\n  if (!amount || !item_name) return res.status(400).send('amount and item_name required');\n\n  const m_payment_id = `ecd-${Date.now()}-${Math.floor(Math.random() * 10000)}`;\n  orders[m_payment_id] = { amount: Number(amount), item_name, email, status: 'pending' };\n\n  const payfastParams = {\n    merchant_id: MERCHANT_ID,\n    merchant_key: MERCHANT_KEY,\n    return_url: `${PUBLIC_BASE_URL}/pay-success.html`,\n    cancel_url: `${PUBLIC_BASE_URL}/pay-cancel.html`,\n    notify_url: `${PUBLIC_BASE_URL}/ipn`,\n    m_payment_id,\n    amount: Number(amount).toFixed(2),\n    item_name,\n    email_address: email || '',\n  };\n\n  const signature = generateSignature(payfastParams, PASSPHRASE);\n  payfastParams.signature = signature;\n\n  const actionUrl = `${PAYFAST_BASE}/eng/process`;\n  res.send(buildPayFastForm(actionUrl, payfastParams));\n});\n\n/**\n * Create a subscription (initial payment)\n */\napp.post('/create-subscription', (req, res) => {\n  const { amount, item_name, email, user_id, interval } = req.body;\n  if (!amount || !item_name || !interval) return res.status(400).send('amount, item_name and interval required');\n\n  const m_payment_id = `sub-${Date.now()}-${Math.floor(Math.random() * 10000)}`;\n\n  subscriptions[m_payment_id] = {\n    user_id: user_id || null,\n    amount: Number(amount),\n    item_name,\n    email,\n    interval,\n    status: 'pending',\n  };\n\n  const payfastParams = buildSubscriptionParams({\n    merchantId: MERCHANT_ID,\n    merchantKey: MERCHANT_KEY,\n    returnUrl: `${PUBLIC_BASE_URL}/subscription-success.html`,\n    cancelUrl: `${PUBLIC_BASE_URL}/subscription-cancel.html`,\n    notifyUrl: `${PUBLIC_BASE_URL}/ipn`,\n    m_payment_id,\n    amount,\n    item_name,\n    email,\n    intervalUnit: interval,\n    intervalCount: 1,\n    passphrase: PASSPHRASE,\n  });\n\n  const actionUrl = `${PAYFAST_BASE}/eng/process`;\n  res.send(buildPayFastForm(actionUrl, payfastParams));\n});\n\n/**\n * IPN endpoint\n */\napp.post('/ipn', async (req, res) => {\n  // Respond quickly\n  res.status(200).end();\n\n  try {\n    const pfData = req.body;\n    const receivedSignature = pfData.signature || '';\n    const localSig = generateSignature(pfData, PASSPHRASE);\n\n    if (!receivedSignature || receivedSignature !== localSig) {\n      console.warn('IPN signature mismatch', { receivedSignature, localSig });\n      return;\n    }\n\n    const validateUrl = `${PAYFAST_BASE}/eng/query/validate`;\n    const bodyStr = Object.keys(pfData)\n      .sort()\n      .map((k) => `${encodeURIComponent(k)}=${encodeURIComponent(pfData[k])}`)\n      .join('&');\n\n    const validateResp = await fetch(validateUrl, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n      body: bodyStr,\n    });\n    const validateText = (await validateResp.text()).trim();\n    if (validateText !== 'VALID') {\n      console.warn('IPN server-to-server validation failed:', validateText);\n      return;\n    }\n\n    const m_payment_id = pfData.m_payment_id;\n    const payment_status = pfData.payment_status;\n    const pf_amount = parseFloat(pfData.amount || '0');\n\n    if (orders[m_payment_id]) {\n      const order = orders[m_payment_id];\n      if (pf_amount !== Number(order.amount)) {\n        console.warn('IPN amount mismatch', { expected: order.amount, received: pf_amount });\n        return;\n      }\n      if (payment_status === 'COMPLETE') {\n        order.status = 'paid';\n        console.log('Order paid:', m_payment_id);\n      }\n      return;\n    }\n\n    if (subscriptions[m_payment_id]) {\n      const sub = subscriptions[m_payment_id];\n      if (pf_amount !== Number(sub.amount)) {\n        console.warn('IPN subscription amount mismatch', { expected: sub.amount, received: pf_amount });\n        return;\n      }\n      if (payment_status === 'COMPLETE') {\n        sub.status = 'active';\n        console.log('Subscription payment complete:', m_payment_id);\n      }\n      return;\n    }\n\n    console.warn('IPN received for unknown m_payment_id', m_payment_id);\n  } catch (err) {\n    console.error('Error processing IPN:', err);\n  }\n});\n\napp.get('/', (req, res) => {\n  res.sendFile(path.join(__dirname, 'public', 'payment.html'));\n});\n\app.listen(PORT, () => {\n  console.log(`PayFast test server running on port ${PORT}`);\n  console.log(`Mode: ${MODE} (PayFast base: ${PAYFAST_BASE})`);\n});\n